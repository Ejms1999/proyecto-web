<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <title>Gracias por tu compra | Custom20</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <style>
    .ok-icon { font-size: 64px; }

    /* Estilos para ScooterPoints (navbar y tarjeta) */
    .scooter-points {
      background: linear-gradient(135deg, #FF6B35, #2E86AB);
      color: white;
      padding: 0.5rem 1rem;
      border-radius: 20px;
      margin-right: 1rem;
      font-size: 0.9rem;
      font-weight: 500;
      display: inline-block;
    }
    .points-card {
      border: 1px solid #FF6B35;
      background: linear-gradient(135deg, rgba(255,107,53,.06), rgba(46,134,171,.06));
    }
    .points-badge {
      background: linear-gradient(135deg, #FF6B35, #2E86AB);
      color: white;
      padding: 0.25rem 0.5rem;
      border-radius: 6px;
      font-size: 0.85rem;
    }
  </style>
</head>
<body>
  <div id="navbar-container"></div>

  <main class="container py-5">
    <div class="text-center">
      <div class="ok-icon mb-3">✅</div>
      <h1 class="mb-3">¡Gracias por tu compra!</h1>
      <p class="lead">Tu pedido ha sido procesado correctamente.</p>

      <!-- Tarjeta resumen de pedido (tu diseño original) -->
      <div class="card mx-auto my-4" style="max-width: 480px;">
        <div class="card-body">
          <div class="d-flex justify-content-between">
            <span class="fw-semibold">N° de pedido</span>
            <span id="orderNumber"></span>
          </div>
          <div id="discountInfo" class="d-none">
            <div class="d-flex justify-content-between mt-2">
              <span class="fw-semibold text-success">Descuento Duoc (20%)</span>
              <span class="text-success" id="orderDiscount">-$0</span>
            </div>
          </div>
          <div class="d-flex justify-content-between mt-2">
            <span class="fw-semibold">Total pagado</span>
            <span id="orderTotal">$0</span>
          </div>
        </div>
      </div>

      <!-- Tarjeta de ScooterPoints -->
      <div class="card points-card mx-auto mb-4" style="max-width: 520px;">
        <div class="card-body">
          <h5 class="card-title mb-3"><i class="bi bi-star-fill text-warning"></i> ScooterPoints</h5>
          <div class="d-flex justify-content-between">
            <span>Puntos ganados en esta compra</span>
            <span class="points-badge" id="pointsEarned">0 pts</span>
          </div>
          <div class="d-flex justify-content-between mt-2">
            <span>Total acumulado</span>
            <span class="fw-semibold" id="pointsTotal">0 pts</span>
          </div>
          <div class="d-flex justify-content-between mt-2">
            <span>Nivel actual</span>
            <span class="badge bg-primary" id="pointsTier">Beginner</span>
          </div>
        </div>
      </div>

      <a class="btn btn-primary" href="index.html">Volver al inicio</a>
    </div>
  </main>

  <div id="footer-container"></div>

  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="assets/js/auth.js"></script>
  <script src="assets/js/layout.js"></script>
  <script>
    // Misma lógica de número de pedido
    function genOrderNumber() {
      const letters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
      const A = letters[Math.floor(Math.random()*26)];
      const B = letters[Math.floor(Math.random()*26)];
      const C = letters[Math.floor(Math.random()*26)];
      const num = String(Math.floor(Math.random()*900000)+100000);
      return `${A}${B}${C}-${num}`;
    }

    // Cálculo de nivel igual al del carrito (mantener consistencia)
    function calculateTier(points) {
      points = Number(points) || 0;
      if (points >= 1000) return "Pro";
      if (points >= 500)  return "Expert";
      if (points >= 200)  return "Advanced";
      return "Beginner";
    }

    $(function () {
      // Permitir ver solo logueado (mantengo tu comportamiento)
      let user = null;
      if (window.AuthStore && window.AuthStore.getCurrentUser) {
        user = AuthStore.getCurrentUser();
      } else {
        // Fallback por si AuthStore no está disponible aún
        try {
          const u = localStorage.getItem('APP_CURRENT_USER');
          if (u) user = JSON.parse(u);
        } catch (_) {}
      }
      if (!user) { location.href = 'login.html'; return; }

      // Cargar navbar/footer
      if (window.Layout && Layout.loadPartials) {
        Layout.loadPartials();
      }

      // Total de la compra (traído desde carrito)
      const total = sessionStorage.getItem('LAST_ORDER_TOTAL') || '$0';
      const discount = Number(sessionStorage.getItem('LAST_ORDER_DISCOUNT') || '0');
      
      // Mostrar descuento si aplica
      if (discount > 0) {
        $('#discountInfo').removeClass('d-none');
        $('#orderDiscount').text(`-$${discount.toLocaleString('es-CL')}`);
      }
      
      $('#orderTotal').text(total);

      // Número de pedido
      $('#orderNumber').text(genOrderNumber());

      // Mostrar puntos ganados y acumulados
      const earned = Number(sessionStorage.getItem('LAST_ORDER_POINTS') || '0');
      let totalPoints = 0;
      let tier = "Beginner";
      
      // Obtener puntos del usuario actual
      if (window.AuthStore && window.AuthStore.getCurrentUser) {
        const currentUser = window.AuthStore.getCurrentUser();
        if (currentUser) {
          totalPoints = currentUser.points || 0;
          tier = window.AuthStore.calculateTier(totalPoints);
        }
      } else {
        // Fallback al sistema anterior
        totalPoints = Number(localStorage.getItem('scooterPoints') || '0');
        tier = calculateTier(totalPoints);
      }

      $('#pointsEarned').text(`${earned} pts`);
      $('#pointsTotal').text(`${totalPoints} pts`);
      $('#pointsTier').text(tier);

      // Limpiar los datos de sesión para no re-repetir el mensaje al recargar
      sessionStorage.removeItem('LAST_ORDER_POINTS');
      sessionStorage.removeItem('LAST_ORDER_DISCOUNT');
    });
  </script>
</body>
</html>
