<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <title>Carrito | Custom20</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <!-- Custom20 Styles -->
  <link href="assets/css/styles.css" rel="stylesheet">

  <!-- ScooterPoints styles -->
  <style>
    /* Estilos para ScooterPoints */
    .scooter-points {
      background: linear-gradient(135deg, #FF6B35, #2E86AB);
      color: white;
      padding: 0.5rem 1rem;
      border-radius: 20px;
      margin-right: 1rem;
      font-size: 0.9rem;
      font-weight: 500;
    }
    .points-summary {
      background: linear-gradient(135deg, rgba(255, 107, 53, 0.1), rgba(46, 134, 171, 0.1));
      border: 1px solid #FF6B35;
      border-radius: 10px;
      padding: 1.5rem;
      margin-bottom: 1.5rem;
    }
    .points-badge {
      background: linear-gradient(135deg, #FF6B35, #2E86AB);
      color: white;
      padding: 0.25rem 0.5rem;
      border-radius: 4px;
      font-size: 0.8rem;
      display: inline-block;
      min-width: 56px;
      text-align: center;
    }
  </style>
</head>
<body>
  <nav class="navbar navbar-expand-lg bg-white border-bottom sticky-top">
    <div class="container">
      <a class="navbar-brand fw-bold" href="index.html"><i class="bi bi-scooter"></i> Custom20.cl</a>
      
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#mainNav">
        <span class="navbar-toggler-icon"></span>
      </button>

      <div class="collapse navbar-collapse" id="mainNav">
        <ul class="navbar-nav me-auto">
          <li class="nav-item admin-only d-none"><a class="nav-link" href="admin.html">Admin Productos</a></li>
          <li class="nav-item"><a class="nav-link" href="index.html"><i class="bi bi-house"></i> Inicio</a></li>
          <li class="nav-item"><a class="nav-link" href="productos.html">Repuestos</a></li>
          <li class="nav-item"><a class="nav-link" href="servicios.html">Servicios</a></li>
          <li class="nav-item"><a class="nav-link" href="preguntas.html">Preguntas</a></li>
          <li class="nav-item"><a class="nav-link" href="contacto.html">Contacto</a></li>
        </ul>

        <ul class="navbar-nav ms-auto">
          <!-- ScooterPoints (solo visible logueado) -->
          <li class="nav-item d-none me-2" id="scooterPointsSection">
            <span class="scooter-points">
              <i class="bi bi-trophy"></i> Nivel: <span id="user-tier">Beginner</span> | 
              <i class="bi bi-star"></i> <span id="user-points">0</span> pts
            </span>
          </li>

          <li class="nav-item me-3">
            <a class="nav-link position-relative" href="carrito.html">
              üõí Carrito
              <span id="cartCount" class="badge bg-primary text-white position-absolute top-0 start-100 translate-middle">0</span>
            </a>
          </li>
          <li class="nav-item" id="loginSection">
            <a class="btn btn-outline-primary btn-sm" href="login.html">
              <i class="bi bi-box-arrow-in-right me-1"></i>Iniciar Sesi√≥n
            </a>
          </li>
          <li class="nav-item d-none" id="userSection">
            <span class="navbar-text me-2" id="navUserName">Invitado</span>
            <a class="btn btn-outline-secondary btn-sm" href="#" id="btnLogout">
              <i class="bi bi-box-arrow-right me-1"></i>Salir
            </a>
          </li>
        </ul>
      </div>
    </div>
  </nav>
  
  <div id="navbar-container" style="display: none;"></div>

  <main class="container py-5">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h1 class="mb-0">Carrito de compras</h1>
      <div class="d-flex gap-2 align-items-center">
        <button class="btn btn-outline-info btn-sm" id="btnDebug" title="Debug - Ver datos en consola">
          <i class="bi bi-bug"></i>
        </button>
        <button class="btn btn-outline-warning btn-sm" id="btnReset" title="Reset - Limpiar y regenerar productos">
          <i class="bi bi-arrow-clockwise"></i>
        </button>
        <button class="btn btn-outline-danger btn-sm" id="btnCleanInvalid" title="Limpiar productos inv√°lidos del carrito">
          <i class="bi bi-exclamation-triangle"></i>
        </button>
        <span class="badge bg-primary fs-6" id="cartCountHeader">0 productos</span>
      </div>
    </div>

    <!-- Resumen de puntos -->
    <div class="points-summary">
      <h2 class="h5"><i class="bi bi-star-fill text-warning"></i> ScooterPoints</h2>
      <div class="row">
        <div class="col-md-6">
          <p class="mb-1">Puntos acumulados: <strong id="current-points">0</strong></p>
          <p class="mb-1">Puntos por esta compra: <strong id="points-from-cart">0</strong></p>
        </div>
        <div class="col-md-6">
          <p class="mb-1">Total despu√©s de compra: <strong id="total-after-purchase">0</strong></p>
          <p class="mb-0">Nivel despu√©s de compra: <span class="badge bg-primary" id="tier-after-purchase">Beginner</span></p>
        </div>
      </div>
    </div>

    <div id="cartEmpty" class="alert alert-info d-none">
      <div class="text-center">
        <i class="bi bi-cart-x" style="font-size: 3rem; color: #6c757d;"></i>
        <h4 class="mt-3">Tu carrito est√° vac√≠o</h4>
        <p class="mb-0">Agrega algunos productos para comenzar tu compra</p>
        <a href="productos.html" class="btn btn-primary mt-3">
          <i class="bi bi-arrow-left me-2"></i>Ver productos
        </a>
      </div>
    </div>

    <div class="table-responsive">
      <table class="table table-hover align-middle" id="tablaCarrito">
        <thead class="table-dark">
          <tr>
            <th>#</th>
            <th>Producto</th>
            <th>C√≥digo</th>
            <th class="text-end">Precio</th>
            <th class="text-center">Cantidad</th>
            <th class="text-end">Puntos</th> <!-- Nueva columna -->
            <th class="text-end">Subtotal</th>
            <th class="text-center">Acciones</th>
          </tr>
        </thead>
        <tbody></tbody>
        <tfoot class="table-light">
          <tr id="discountRow" class="d-none">
            <th colspan="6" class="text-end fs-6 text-success">Descuento Duoc (20%):</th>
            <th class="text-end fs-6 text-success" id="discountAmount">-$0</th>
            <th></th>
          </tr>
          <tr>
            <th colspan="6" class="text-end fs-5">Total a pagar:</th>
            <th class="text-end fs-4 text-primary" id="cartTotal">$0</th>
            <th></th>
          </tr>
        </tfoot>
      </table>
    </div>

    <div class="d-flex justify-content-between align-items-center mt-4">
      <div>
        <a class="btn btn-outline-secondary" href="productos.html">
          <i class="bi bi-arrow-left me-2"></i>Seguir comprando
        </a>
      </div>
      <div class="d-flex gap-2">
        <button class="btn btn-outline-danger" id="btnVaciar">
          <i class="bi bi-trash me-2"></i>Vaciar carrito
        </button>
        <button class="btn btn-primary btn-lg" id="btnConfirmar" disabled>
          <i class="bi bi-check-circle me-2"></i>Confirmar compra
        </button>
      </div>
    </div>
  </main>

  <footer class="custom20-footer mt-5">
    <div class="container">
      <div class="row">
        <div class="col-md-6">
          <h5>Custom20.cl</h5>
          <p>Repuestos y accesorios para scooters el√©ctricos</p>
        </div>
        <div class="col-md-6 text-md-end">
          <p>&copy; <span id="yearNow"></span> Custom20.cl - Todos los derechos reservados</p>
        </div>
      </div>
    </div>
  </footer>
  
  <div id="footer-container" style="display: none;"></div>

  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="assets/js/auth.js"></script>
  <script src="assets/js/layaout.js"></script>

  <script>
    const CART_KEY = 'APP_CART';
    const PROD_KEY = 'APP_PRODS';
    const fmt = new Intl.NumberFormat('es-CL', { style: 'currency', currency: 'CLP', maximumFractionDigits: 0 });

    function getCart() {
      try { return JSON.parse(localStorage.getItem(CART_KEY)) || []; } catch { return []; }
    }
    function saveCart(cart) {
      console.log('Guardando carrito:', cart);
      localStorage.setItem(CART_KEY, JSON.stringify(cart));
      console.log('Carrito guardado en localStorage');
      // avisa al navbar para refrescar badge
      window.dispatchEvent(new CustomEvent('cart:updated'));
    }
    function getProds() {
      try { return JSON.parse(localStorage.getItem(PROD_KEY)) || []; } catch { return []; }
    }
    function findProdInfo(id) {
      const p = getProds().find(x => String(x.id) === String(id));
      if (p) return { 
        name: p.nombre, 
        price: Number(p.precio)||0,
        codigo: p.codigo,
        descripcion: p.descripcion,
        categoria: p.categoria,
        marca: p.marca,
        stock: Number(p.stock) || 0
      };
      return null;
    }

    // =========================
    //   SISTEMA SCOOTERPOINTS
    // =========================
    class ScooterPointsSystem {
      constructor() {
        this.currentUser = null;
        this.userPoints = 0;
        this.userTier = "Beginner";
        this.updateUserData();
        this.updateDisplay();
      }
      
      updateUserData() {
        if (window.AuthStore && window.AuthStore.getCurrentUser) {
          this.currentUser = window.AuthStore.getCurrentUser();
          if (this.currentUser) {
            this.userPoints = this.currentUser.points || 0;
            this.userTier = window.AuthStore.calculateTier(this.userPoints);
          }
        }
      }
      
      calculateTier(points) {
        if (window.AuthStore && window.AuthStore.calculateTier) {
          return window.AuthStore.calculateTier(points);
        }
        if (points >= 1000) return "Pro";
        if (points >= 500) return "Expert";
        if (points >= 200) return "Advanced";
        return "Beginner";
      }
      
      addPoints(points) {
        // Actualizar datos del usuario antes de agregar puntos
        this.updateUserData();
        
        if (!this.currentUser) {
          console.warn('No hay usuario logueado para agregar puntos');
          return 0;
        }
        
        console.log('Agregando puntos:', points, 'al usuario:', this.currentUser.email);
        
        if (window.AuthStore && window.AuthStore.addUserPoints) {
          this.userPoints = window.AuthStore.addUserPoints(this.currentUser.email, points);
          this.userTier = this.calculateTier(this.userPoints);
          this.updateDisplay();
          console.log('Puntos actualizados:', this.userPoints);
          return this.userPoints;
        }
        
        // Fallback al sistema anterior si AuthStore no est√° disponible
        this.userPoints += points;
        localStorage.setItem('scooterPoints', String(this.userPoints));
        this.userTier = this.calculateTier(this.userPoints);
        this.updateDisplay();
        return this.userPoints;
      }
      
      updateDisplay() {
        const tierElement = document.getElementById('user-tier');
        const pointsElement = document.getElementById('user-points');
        if (tierElement) tierElement.textContent = this.userTier;
        if (pointsElement) pointsElement.textContent = this.userPoints;
      }
      
      getPoints() { 
        this.updateUserData();
        return this.userPoints; 
      }
      
      getTier() { 
        this.updateUserData();
        return this.userTier; 
      }
    }

    // 1 punto por cada $1000 CLP de gasto
    function calculatePointsFromPrice(price) {
      return Math.floor(price / 1000);
    }

    // Verificar si el usuario tiene descuento de dominio Duoc
    function hasDuocDiscount() {
      if (window.AuthStore && window.AuthStore.getCurrentUser) {
        const user = window.AuthStore.getCurrentUser();
        if (user && user.email) {
          return user.email.toLowerCase().includes('@duocuc.cl') || user.email.toLowerCase().includes('@duoc.cl');
        }
      }
      return false;
    }

    // Calcular descuento (20% para usuarios Duoc)
    function calculateDiscount(total) {
      if (hasDuocDiscount()) {
        return Math.floor(total * 0.2); // 20% de descuento
      }
      return 0;
    }

    // Inicializar sistema (global para que auth/layaout puedan usarlo si quieren)
    window.scooterPoints = new ScooterPointsSystem();

    // Actualiza el resumen de puntos
    function updatePointsDisplay() {
      const cart = getCart();
      let totalPoints = 0;
      let totalPrice = 0;

      cart.forEach(item => {
        const prodInfo = findProdInfo(item.id);
        const price = (typeof item.price === 'number') ? item.price : (prodInfo?.price || 0);
        const qty = Number(item.qty) || 1;
        const itemTotal = price * qty;
        totalPrice += itemTotal;
        totalPoints += calculatePointsFromPrice(itemTotal);
      });

      // Actualizar datos del usuario antes de mostrar
      window.scooterPoints.updateUserData();

      const $current = document.getElementById('current-points');
      const $fromCart = document.getElementById('points-from-cart');
      const $after = document.getElementById('total-after-purchase');
      const $tierAfter = document.getElementById('tier-after-purchase');

      if ($current) $current.textContent = window.scooterPoints.getPoints();
      if ($fromCart) $fromCart.textContent = totalPoints;
      if ($after) $after.textContent = window.scooterPoints.getPoints() + totalPoints;
      if ($tierAfter) $tierAfter.textContent =
        window.scooterPoints.calculateTier(window.scooterPoints.getPoints() + totalPoints);

      return totalPoints;
    }

    // =========================
    //   VALIDAR CARRITO
    // =========================
    function validateCartAgainstInventory() {
      const cart = getCart();
      const products = getProds();
      let cartModified = false;
      let removedItems = [];
      let adjustedItems = [];

      const validCart = cart.filter(item => {
        const product = products.find(p => String(p.id) === String(item.id));
        
        if (!product) {
          removedItems.push(item.name || `Producto ${item.id}`);
          cartModified = true;
          return false;
        }

        const availableStock = Number(product.stock) || 0;
        const requestedQty = Number(item.qty) || 1;

        if (requestedQty > availableStock) {
          if (availableStock > 0) {
            item.qty = availableStock;
            adjustedItems.push({
              name: item.name || product.nombre,
              requested: requestedQty,
              available: availableStock
            });
            cartModified = true;
            return true;
          } else {
            removedItems.push(item.name || product.nombre);
            cartModified = true;
            return false;
          }
        }
        return true;
      });

      if (cartModified) {
        saveCart(validCart);
        if (removedItems.length > 0) {
          alert(`Productos eliminados del carrito (sin stock):\n${removedItems.join('\n')}`);
        }
        if (adjustedItems.length > 0) {
          const adjustments = adjustedItems.map(item => 
            `${item.name}: ${item.requested} ‚Üí ${item.available}`
          ).join('\n');
          alert(`Cantidades ajustadas por stock disponible:\n${adjustments}`);
        }
      }
      return validCart;
    }

    // =========================
    //   RENDER CARRITO
    // =========================
    function renderCarrito() {
      const validCart = validateCartAgainstInventory();
      const $tbody = $('#tablaCarrito tbody').empty();
      let total = 0;

      if (!validCart.length) {
        $('#cartEmpty').removeClass('d-none');
        $('#btnConfirmar').prop('disabled', true);
      } else {
        $('#cartEmpty').addClass('d-none');
        $('#btnConfirmar').prop('disabled', false);
      }

      validCart.forEach((it, i) => {
        const prodInfo = findProdInfo(it.id);
        let name = it.name || prodInfo?.name || `Producto ${it.id}`;
        let price = (typeof it.price === 'number') ? it.price : (prodInfo?.price || 0);
        let codigo = it.codigo || prodInfo?.codigo || 'N/A';
        let descripcion = it.descripcion || prodInfo?.descripcion || '';
        let qty = Number(it.qty) || 1;

        const subtotal = price * qty;
        total += subtotal;
        const itemPoints = calculatePointsFromPrice(subtotal);

        $tbody.append(`
          <tr data-id="${it.id}">
            <td>${i+1}</td>
            <td>
              <div>
                <strong>${name}</strong>
                ${descripcion ? `<br><small class="text-muted">${descripcion}</small>` : ''}
              </div>
            </td>
            <td><code class="text-primary">${codigo}</code></td>
            <td class="text-end">${fmt.format(price)}</td>
            <td class="text-center">
              <div class="btn-group btn-group-sm" role="group">
              <button type="button" class="btn btn-outline-secondary btnQty" data-delta="-1">-</button>
              <span class="btn btn-light disabled px-3">${qty}</span>
              <button type="button" class="btn btn-outline-secondary btnQty" data-delta="1">+</button>
              </div>
            </td>
            <td class="text-end">
              <span class="points-badge">${itemPoints} pts</span>
            </td>
            <td class="text-end">${fmt.format(subtotal)}</td>
            <td class="text-center">
              <button type="button" class="btn btn-sm btn-outline-danger btnRemove" title="Eliminar producto">
                <i class="bi bi-trash"></i>
            </button>
            </td>
            </tr>
        `);
      });

      // Calcular descuento y total final
      const discount = calculateDiscount(total);
      const finalTotal = total - discount;
      
      // Mostrar/ocultar fila de descuento
      const $discountRow = $('#discountRow');
      const $discountAmount = $('#discountAmount');
      
      if (discount > 0) {
        $discountRow.removeClass('d-none');
        $discountAmount.text(`-${fmt.format(discount)}`);
      } else {
        $discountRow.addClass('d-none');
      }
      
      $('#cartTotal').text(fmt.format(finalTotal));

      // Actualizar resumen de puntos
      updatePointsDisplay();
    }

    // =========================
    //   CONTADOR CARRITO
    // =========================
    function updateCartCount() {
  const cart = JSON.parse(localStorage.getItem('APP_CART') || '[]');
  const totalItems = cart.reduce((sum, item) => sum + (item.qty || 1), 0);

  // Badge del navbar
  const cartCountEl = document.getElementById('cartCount');
  if (cartCountEl) cartCountEl.textContent = totalItems;

  // Badge del header
  const headerCartCount = document.getElementById('cartCountHeader');
  if (headerCartCount) {
    headerCartCount.textContent = `${totalItems} producto${totalItems !== 1 ? 's' : ''}`;
  }
}

    $(function () {
      console.log('Inicializando carrito...');
      document.getElementById("yearNow").textContent = new Date().getFullYear();

      updateCartCount();

      // Refrescar por eventos entre p√°ginas
      window.addEventListener('cart:updated', () => {
        console.log('Evento cart:updated recibido');
        updateCartCount();
        renderCarrito();
      });
      window.addEventListener('storage', function(e) {
        if (e.key === 'APP_CART') {
          console.log('Cambio detectado en localStorage del carrito');
          updateCartCount();
          renderCarrito();
        }
      });

      // Auth en navbar (con fallback)
      function updateNavbarAuth() {
        console.log('Actualizando navbar de autenticaci√≥n en carrito...');
        let user = null;
        if (window.AuthStore && window.AuthStore.getCurrentUser) {
          user = window.AuthStore.getCurrentUser();
        } else {
          try {
            const userData = localStorage.getItem('APP_CURRENT_USER');
            if (userData) user = JSON.parse(userData);
          } catch (e) { console.error('Error al obtener usuario desde localStorage:', e); }
        }

        const loginSection = document.getElementById('loginSection');
        const userSection = document.getElementById('userSection');
        const spSection = document.getElementById('scooterPointsSection');

        if (user) {
          if (loginSection) loginSection.classList.add('d-none');
          if (userSection) {
            userSection.classList.remove('d-none');
            const userNameEl = document.getElementById('navUserName');
            if (userNameEl) userNameEl.textContent = user.name || 'Usuario';
          }
          // Enlaces admin
          if (user.role === 'admin') {
            document.querySelectorAll('.admin-only').forEach(link => link.classList.remove('d-none'));
          }
          // Mostrar ScooterPoints + refrescar visor
          if (spSection) spSection.classList.remove('d-none');
          if (window.scooterPoints) window.scooterPoints.updateDisplay();
        } else {
          if (loginSection) loginSection.classList.remove('d-none');
          if (userSection) userSection.classList.add('d-none');
          document.querySelectorAll('.admin-only').forEach(link => link.classList.add('d-none'));
          if (spSection) spSection.classList.add('d-none');
        }
      }

      // Ejecutar auth navbar
      updateNavbarAuth();
      setTimeout(updateNavbarAuth, 100);
      window.addEventListener('auth:login', updateNavbarAuth);
      window.addEventListener('auth:logout', updateNavbarAuth);

      // Cargar partials (si existen)
      if (window.Layout && window.Layout.loadPartials) {
        Layout.loadPartials();
      } else {
        console.warn('Layout no est√° disponible, continuando sin partials');
      }

      // Render inicial
      renderCarrito();

      // Bot√≥n de debug
      $('#btnDebug').on('click', function() {
        console.log('=== DEBUG CARRITO ===');
        console.log('Carrito:', getCart());
        console.log('Productos:', getProds());
        console.log('localStorage APP_CART:', localStorage.getItem('APP_CART'));
        console.log('localStorage APP_PRODS:', localStorage.getItem('APP_PRODS'));
        console.log('scooterPoints:', localStorage.getItem('scooterPoints'));
        alert('Datos mostrados en consola (F12)');
      });

      // Reset
      $('#btnReset').on('click', function() {
        if (confirm('¬øEst√°s seguro? Esto limpiar√° el carrito y regenerar√° los productos.')) {
          localStorage.removeItem('APP_CART');
          localStorage.removeItem('APP_PRODS');
          location.reload();
        }
      });

      // Limpiar inv√°lidos
      $('#btnCleanInvalid').on('click', function() {
        if (confirm('¬øLimpiar productos que exceden el stock disponible?')) {
          validateCartAgainstInventory();
          renderCarrito();
          updateCartCount();
          alert('Carrito validado contra inventario');
        }
      });

      // Vaciar (robusto)
      $('#btnVaciar').off('click').on('click', function (e) {
        e.preventDefault();
        e.stopPropagation();

        if (!confirm('¬øEst√°s seguro de que quieres vaciar el carrito?')) return;

        // Limpieza a prueba de todo
        localStorage.removeItem(CART_KEY);          // borra la clave
        localStorage.setItem(CART_KEY, '[]');       // y deja un array vac√≠o por compatibilidad
        window.dispatchEvent(new CustomEvent('cart:updated')); // avisa a otros componentes

        renderCarrito();    // re-render tabla
        updateCartCount();  // actualiza badges
        console.log('Carrito vaciado');
      });
      // Cambiar cantidades
      $(document).on('click', '.btnQty', function () {
        const delta = Number($(this).data('delta'));
        const id = $(this).closest('tr').data('id');
        const cart = getCart();
        const item = cart.find(x => String(x.id) === String(id));
        if (!item) return;

        const newQty = (Number(item.qty) || 1) + delta;

        if (newQty <= 0) {
          const next = cart.filter(x => String(x.id) !== String(id));
          saveCart(next);
        } else {
          const product = getProds().find(p => String(p.id) === String(id));
          if (product) {
            const availableStock = Number(product.stock) || 0;
            if (newQty > availableStock) {
              alert(`Solo hay ${availableStock} unidades disponibles de ${item.name || product.nombre}`);
              return;
            }
          }
          item.qty = newQty;
          saveCart(cart);
        }
        renderCarrito();
        updateCartCount();
      });

      // Eliminar item
      // Eliminar item (versi√≥n robusta)
      $(document).on('click', '.btnRemove', function (e) {
        e.preventDefault();
        e.stopPropagation();

        const $tr = $(this).closest('tr');
        const id = String($tr.data('id'));

        const cart = getCart();
        const next = cart.filter(x => String(x.id) !== id);

        saveCart(next);
        $tr.remove();        // remueve la fila al tiro (optimista)
        renderCarrito();     // recalcula totales y puntos
        updateCartCount();   // actualiza badges de carrito
      });
      // Confirmar compra
      $('#btnConfirmar').on('click', () => {
        // 1) Verifica login
        let user = null;
        if (window.AuthStore && window.AuthStore.getCurrentUser) {
          user = AuthStore.getCurrentUser();
        } else {
          try { const u = localStorage.getItem('APP_CURRENT_USER'); if (u) user = JSON.parse(u); } catch(_){}
        }
        if (!user) {
          alert('Debes iniciar sesi√≥n para confirmar tu compra');
          location.href = 'login.html';
          return;
        }

        // 2) Calcula puntos de ESTA compra (no guarda a√∫n)
        const totalText = $('#cartTotal').text();
        const totalPoints = updatePointsDisplay();   // ‚Üê solo calcula
        
        console.log('Puntos calculados para esta compra:', totalPoints);
        console.log('Usuario actual:', user);
        
        // Guardar tambi√©n el descuento aplicado para mostrar en gracias.html
        const discount = calculateDiscount(getCart().reduce((sum, item) => {
          const prodInfo = findProdInfo(item.id);
          const price = (typeof item.price === 'number') ? item.price : (prodInfo?.price || 0);
          const qty = Number(item.qty) || 1;
          return sum + (price * qty);
        }, 0));

        // 3) AHORA S√ç: suma los puntos al acumulado usando el sistema por usuario
        console.log('Intentando agregar puntos...');
        const newPoints = window.scooterPoints.addPoints(totalPoints);
        console.log('Puntos despu√©s de agregar:', newPoints);

        // 4) Enviar datos a gracias.html
        sessionStorage.setItem('LAST_ORDER_TOTAL', totalText);
        sessionStorage.setItem('LAST_ORDER_POINTS', String(totalPoints));
        sessionStorage.setItem('LAST_ORDER_DISCOUNT', String(discount));

        // 5) Limpia carrito y redirige
        saveCart([]);
        updateCartCount();
        location.href = 'gracias.html';
      });
    });
  </script>
</body>
</html>
