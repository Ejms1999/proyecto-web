<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <title>Registro</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Custom20 Styles -->
  <link href="assets/css/styles.css" rel="stylesheet">
</head>
<body class="bg-light">
  <div class="container py-5">
    <div class="row justify-content-center">
      <div class="col-12 col-md-6">
        <div class="card">
          <div class="card-body">
            <h1 class="h4 mb-3 text-center">Registro</h1>

            <form id="registroForm">
              <div class="mb-3"><label class="form-label">Nombre</label><input id="nombre" class="form-control" required></div>
              <div class="mb-3"><label class="form-label">Correo</label><input id="correo" type="email" class="form-control" required></div>
              <div class="mb-3"><label class="form-label">Contraseña</label><input id="pass" type="password" class="form-control" minlength="6" required></div>
              <div id="regError" class="alert alert-danger d-none"></div>
              <div id="regOk" class="alert alert-success d-none">Registro exitoso</div>
              <button type="submit" class="btn btn-success w-100">Registrarse</button>
            </form>

            <hr>
            <p class="text-center"><a href="login.html">Volver al login</a></p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="assets/js/auth.js"></script>
  <script>
  // Fallback si auth.js no se carga
  if (typeof AuthStore === 'undefined') {
    console.warn('AuthStore no se cargó, creando fallback...');
    window.AuthStore = {
      registerUser: function({name, email, password}) {
        // Validaciones básicas
        if (!name || !email || !password) {
          return { ok: false, message: 'Todos los campos son obligatorios.' };
        }
        if (password.length < 6) {
          return { ok: false, message: 'La contraseña debe tener al menos 6 caracteres.' };
        }
        if (!email.includes('@duocuc.cl') && !email.includes('@duoc.cl') && !email.includes('@gmail.com')) {
          return { ok: false, message: 'Dominio no permitido. Usa @duocuc.cl, @duoc.cl o @gmail.com.' };
        }
        
        // Obtener usuarios existentes
        const users = JSON.parse(localStorage.getItem('APP_USERS') || '[]');
        
        // Verificar si el email ya existe
        if (users.find(u => u.email.toLowerCase() === email.toLowerCase())) {
          return { ok: false, message: 'El correo ya está registrado.' };
        }
        
        // Crear nuevo usuario
        const newUser = { name: name.trim(), email: email.trim(), pass: password.trim(), role: 'user' };
        users.push(newUser);
        localStorage.setItem('APP_USERS', JSON.stringify(users));
        
        // Auto-login
        localStorage.setItem('APP_CURRENT_USER', JSON.stringify({
          name: newUser.name, email: newUser.email, role: newUser.role
        }));
        
        return { ok: true, code: 'registered_and_logged_in', user: newUser, dest: 'index.html' };
      }
    };
    console.log('Fallback AuthStore creado');
  }
  </script>
  <script>
  $(function(){
    // Verificar si AuthStore se cargó correctamente
    if (typeof AuthStore === 'undefined') {
      console.error('AuthStore no se cargó correctamente');
      $('#regError').removeClass('d-none').text('Error: No se pudo cargar el sistema de autenticación. Recarga la página.');
      return;
    }
    
    console.log('AuthStore cargado correctamente:', AuthStore);
    
    const params = new URLSearchParams(location.search);
    if(params.has('email')) $('#correo').val(params.get('email'));

    $('#registroForm').on('submit', function(e){
      e.preventDefault();
      console.log('Formulario enviado');
      console.log('AuthStore disponible:', typeof AuthStore);
      
      const formData = {
        name: $('#nombre').val(),
        email: $('#correo').val(),
        password: $('#pass').val()
      };
      
      console.log('Datos del formulario:', formData);
      
      if (!AuthStore) {
        $('#regError').removeClass('d-none').text('Error: AuthStore no está disponible');
        return;
      }
      
      const resp = AuthStore.registerUser(formData);
      console.log('Respuesta del registro:', resp);
      
      if(!resp.ok){
        $('#regError').removeClass('d-none').text(resp.message);
        return;
      }
      
      $('#regOk').removeClass('d-none');
      console.log('Registro exitoso, redirigiendo a:', resp.dest || 'index.html');
      setTimeout(()=> window.location.href = resp.dest || 'index.html', 800);
    });
  });
  </script>
  <footer class="custom20-footer mt-5">
    <div class="container text-center">
      <div class="row">
        <div class="col-md-4">
          <h5>Custom20.cl</h5>
          <p>Servicio tecnico de scooter, bicicleta, motos electricas y mas, especialistas en baterias de litio y parte electrica </p>
        </div>
        <div class="col-md-4">
          <h5>Horarios</h5>
          <p>Lun - Vie: 9:00 - 18:00</p>
          <p>Sáb: 10:00 - 14:00</p>
          <p class="text-danger">Emergencias: 24/7</p>
        </div>
        <div class="col-md-4">
          <h5>Ubicación</h5>
          <p>Santiago, Chile</p>
          <p>Servicio a domicilio disponible</p>
        </div>
      </div>
      <div class="container text-center">
        <div class="row">
          <div class="col-md-4">
            <h5>Contacto Directo:</h5>
      </div>
      <p><i class="bi bi-whatsapp text-success"></i> <a href="https://wa.me/56912345678?text=Hola,%20necesito%20ayuda%20para%20registrarme" > 
        +56 9 97290901 </a>       -    
        <i class="bi bi-envelope"></i> <a href="mailto:servicios@custom20.cl?Subject=Hola buenas para mas informacion">Servicios@custom20.cl</a>        -      
        <i class= "bi bi-instagram"></i><a href="https://www.instagram.com/custom20.cl?igsh=OGhuY3M2N3p6NXVs&utm_source=qr"> Custom20.cl </a>
      </p>
        
      <hr>
      <p class="mb-0">© <span id="yearNow"></span> Custom20. Todos los derechos reservados.</p>
    </div>
  </footer>
</body>
</html>
