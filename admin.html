<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <title>Admin Productos</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <!-- Custom20 Styles -->
  <link href="assets/css/styles.css" rel="stylesheet">
</head>
<body>
  <!-- Navbar con respaldo -->
  <nav class="navbar navbar-expand-lg bg-white border-bottom sticky-top">
    <div class="container">
      <a class="navbar-brand fw-bold" href="index.html"><i class="bi bi-battery-charging"></i> Custom20.cl</a>
      
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#mainNav">
        <span class="navbar-toggler-icon"></span>
      </button>

      <div class="collapse navbar-collapse" id="mainNav">
        <ul class="navbar-nav me-auto">
          <li class="nav-item"><a class="nav-link" href="admin.html"><i class="bi bi-gear"></i> Admin Productos</a></li>
          <li class="nav-item"><a class="nav-link" href="index.html"><i class="bi bi-house"></i> Inicio</a></li>
          <li class="nav-item"><a class="nav-link" href="productos.html">Repuestos</a></li>
          <li class="nav-item"><a class="nav-link" href="servicios.html">Servicios</a></li>
          <li class="nav-item"><a class="nav-link" href="preguntas.html">Preguntas</a></li>
          <li class="nav-item"><a class="nav-link" href="contacto.html">Contacto</a></li>
        </ul>

        <ul class="navbar-nav ms-auto">
          <li class="nav-item me-3">
            <a class="nav-link position-relative" href="carrito.html">
              🛒 Carrito
              <span id="cartCount" class="badge bg-primary text-white position-absolute top-0 start-100 translate-middle">0</span>
            </a>
          </li>
          <li class="nav-item"><span class="navbar-text" id="navUserName">Invitado</span></li>
          <li class="nav-item ms-2"><a class="btn btn-outline-secondary btn-sm" href="#" id="btnLogout">Salir</a></li>
        </ul>
      </div>
    </div>
  </nav>
  
  <div id="navbar-container" style="display: none;"></div>

  <main class="container py-5">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h1 class="mb-0">Administración de productos</h1>
      <button class="btn btn-success btn-sm" id="btnNuevo">+ Nuevo</button>
    </div>

    <div class="table-responsive">
      <table class="table table-striped align-middle" id="tablaProductos">
        <thead class="table-dark">
          <tr>
            <th>#</th>
            <th>Producto</th>
            <th>Código</th>
            <th>Precio</th>
            <th>Stock</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </main>

  <!-- Footer con respaldo -->
  <footer class="custom20-footer mt-5">
    <div class="container text-center">
      <p class="mb-0">© <span id="yearNow"></span> Custom20. Todos los derechos reservados.</p>
    </div>
  </footer>
  
  <div id="footer-container" style="display: none;"></div>

  <!-- Modal producto -->
  <div class="modal fade" id="productoModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header"><h5 class="modal-title">Producto</h5></div>
        <div class="modal-body">
          <form id="productoForm" novalidate>
            <input type="hidden" id="prodId">

            <div class="mb-3">
              <label class="form-label">Código del Producto</label>
              <div class="input-group">
                <input id="prodCodigo" class="form-control" readonly>
                <button class="btn btn-outline-secondary" type="button" id="btnGenerarCodigo">
                  <i class="bi bi-arrow-clockwise"></i> Generar
                </button>
              </div>
              <div class="form-text">Código único generado automáticamente</div>
            </div>

            <div class="mb-3">
              <label class="form-label">Nombre</label>
              <input id="prodNombre" class="form-control" required>
            </div>

            <div class="mb-3">
              <label class="form-label">Precio</label>
              <input id="prodPrecio" type="number" class="form-control" required>
            </div>

            <div class="mb-3">
              <label class="form-label">Descripción</label>
              <textarea id="prodDescripcion" class="form-control" rows="3" placeholder="Descripción detallada del producto"></textarea>
            </div>

            <div class="mb-3">
              <label class="form-label">Categoría</label>
              <select id="prodCategoria" class="form-select" required>
                <option value="">Todas las categorías</option>
                <option value="baterias">Baterías</option>
                <option value="cargadores">Cargadores</option>
                <option value="frenos">Sistema de Frenos</option>
                <option value="motor">Motor y Transmisión</option>
                <option value="neumaticos">Neumáticos</option>
                <option value="electrico">Sistema Eléctrico</option>
                <option value="carroceria">Carrocería</option>
                <option value="herramientas">Herramientas</option>
              </select>
            </div>

            <div class="mb-3">
              <label class="form-label">Marca</label>
              <input id="prodMarca" class="form-control" value="Custom20" required>
            </div>

            <div class="mb-3">
              <label class="form-label">Stock</label>
              <input id="prodStock" type="number" class="form-control" min="0" required>
            </div>

            <div class="mb-3">
              <label class="form-label">Imagen (JPG/PNG, máx ~1MB)</label>
              <input id="prodImg" type="file" accept="image/*" class="form-control">
              <div class="form-text">Opcional. Si no subes, se usará una imagen por defecto.</div>
            </div>

            <div class="mb-2">
              <img id="prodPreview" src="" alt="Previsualización" class="img-fluid rounded border d-none">
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button class="btn btn-primary" id="btnGuardarProd">Guardar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="assets/js/auth.js"></script>
  <script src="assets/js/layaout.js"></script>
  <script>
    const PROD_KEY = "APP_PRODS";
    function getProds(){ try { return JSON.parse(localStorage.getItem(PROD_KEY))||[]; } catch { return []; } }
    function saveProds(p){ localStorage.setItem(PROD_KEY, JSON.stringify(p)); }

    // ===== Imagen: lectura/compresión =====
    let currentImgData = ""; // DataURL actual del modal

    function readFileAsDataURL(file){
      return new Promise((res, rej)=>{
        const fr = new FileReader();
        fr.onload = () => res(fr.result);
        fr.onerror = rej;
        fr.readAsDataURL(file);
      });
    }

    // Reescala máximo 800px, calidad 0.85
    async function compressImage(dataURL, maxSize=800, mime='image/jpeg', quality=0.85){
      return new Promise((res)=>{
        const img = new Image();
        img.onload = ()=>{
          const scale = Math.min(maxSize/img.width, maxSize/img.height, 1);
          const w = Math.round(img.width * scale);
          const h = Math.round(img.height * scale);
          const canvas = document.createElement('canvas');
          canvas.width = w; canvas.height = h;
          const ctx = canvas.getContext('2d');
          ctx.drawImage(img, 0, 0, w, h);
          res(canvas.toDataURL(mime, quality));
        };
        img.src = dataURL;
      });
    }

    function renderTabla(){
      const prods = getProds();
      const $tbody = $("#tablaProductos tbody").empty();
      prods.forEach((p,i)=>{
        const thumb = p.img || `https://picsum.photos/seed/prod${p.id}/60/40`;
        const codigo = p.codigo || 'Sin código';
        const categoria = p.categoria || 'Sin categoría';
        $tbody.append(`
          <tr>
            <td>${i+1}</td>
            <td class="d-flex align-items-center gap-2">
              <img src="${thumb}" style="width:60px;height:40px;object-fit:cover;border-radius:6px;border:1px solid #ddd">
              <div>
                <div class="fw-bold">${p.nombre}</div>
                <small class="text-muted">${categoria}</small>
              </div>
            </td>
            <td><code class="text-primary">${codigo}</code></td>
            <td>$${Number(p.precio).toLocaleString('es-CL')}</td>
            <td class="text-center">
              <span class="badge ${p.stock > 10 ? 'bg-success' : p.stock > 0 ? 'bg-warning' : 'bg-danger'}">
                ${p.stock}
              </span>
            </td>
            <td>
              <button class="btn btn-sm btn-primary editar" data-id="${p.id}">
                <i class="bi bi-pencil"></i> Editar
              </button>
              <button class="btn btn-sm btn-danger eliminar" data-id="${p.id}">
                <i class="bi bi-trash"></i> Eliminar
              </button>
            </td>
          </tr>
        `);
      });
    }

    $(function(){
      // Inicializar año
      document.getElementById("yearNow").textContent = new Date().getFullYear();
      
      // Guards
      const user = AuthStore.getCurrentUser();
      if(!user){ location.href="login.html"; return; }
      if(user.role!=="admin"){ location.href="index.html"; return; }

      // Inicializar navbar logic
      if (window.Layout && window.Layout.initNavbarLogic) {
        window.Layout.initNavbarLogic();
      }
      
      // Intentar cargar partials (fallback)
      if (window.Layout && window.Layout.loadPartials) {
        Layout.loadPartials();
      }
      
      renderTabla();

      // Función para generar código único
      function generarCodigoProducto() {
        if (window.AuthStore && window.AuthStore.generateUniqueProductCode) {
          const codigo = window.AuthStore.generateUniqueProductCode();
          $("#prodCodigo").val(codigo);
          console.log('Código generado:', codigo);
        } else {
          console.error('AuthStore no está disponible');
        }
      }

      // Botón para generar nuevo código
      $("#btnGenerarCodigo").on("click", function() {
        generarCodigoProducto();
      });

      // Nuevo
      $("#btnNuevo").on("click", ()=>{
        $("#prodId").val("");
        $("#prodNombre, #prodPrecio, #prodStock, #prodDescripcion, #prodMarca").val("");
        $("#prodCategoria").val("");
        $("#prodImg").val("");
        currentImgData = "";
        $("#prodPreview").attr("src","").addClass("d-none");
        
        // Generar código automáticamente
        generarCodigoProducto();
        
        new bootstrap.Modal("#productoModal").show();
      });

      // Cargar imagen
      $("#prodImg").on("change", async function(){
        const file = this.files[0];
        if(!file) return;
        if(!/image\/(png|jpeg|jpg)/i.test(file.type)){ alert("Sube JPG o PNG"); this.value=""; return; }
        if(file.size > 1.2 * 1024 * 1024){ /* aviso, se comprime igual */ }
        try{
          const raw = await readFileAsDataURL(file);
          currentImgData = await compressImage(raw, 800, 'image/jpeg', 0.85);
          $("#prodPreview").attr("src", currentImgData).removeClass("d-none");
        }catch(e){ console.warn(e); alert("No se pudo leer la imagen."); }
      });

      // Guardar
      $("#btnGuardarProd").on("click", ()=>{
        const id = $("#prodId").val();
        const codigo = $("#prodCodigo").val();
        const nombre = $("#prodNombre").val();
        const precio = $("#prodPrecio").val();
        const stock = $("#prodStock").val();
        const descripcion = $("#prodDescripcion").val();
        const categoria = $("#prodCategoria").val();
        const marca = $("#prodMarca").val();

        // Validaciones
        if (!codigo || !nombre || !precio || !stock || !categoria || !marca) {
          alert('Todos los campos obligatorios deben estar completos');
          return;
        }

        const prods = getProds();
        if(id){
          // Editar producto existente
          const idx = prods.findIndex(p=>String(p.id)===String(id));
          if (idx !== -1) {
            prods[idx].codigo = codigo;
            prods[idx].nombre = nombre;
            prods[idx].precio = Number(precio);
            prods[idx].stock = Number(stock);
            prods[idx].descripcion = descripcion;
            prods[idx].categoria = categoria;
            prods[idx].marca = marca;
            if(currentImgData) prods[idx].img = currentImgData; // reemplaza solo si subió nueva
          }
        }else{
          // Nuevo producto
          const nuevoProducto = {
            id: Date.now(),
            codigo: codigo,
            nombre: nombre,
            descripcion: descripcion,
            precio: Number(precio),
            stock: Number(stock),
            categoria: categoria,
            marca: marca,
            img: currentImgData || "data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZjhmOWZhIi8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxNCIgZmlsbD0iIzZjNzU3ZCIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPkltYWdlbiBwb3IgZGVmZWN0bzwvdGV4dD48L3N2Zz4=",
            fechaCreacion: new Date().toISOString()
          };
          prods.push(nuevoProducto);
          console.log('Producto creado:', nuevoProducto);
        }
        
        saveProds(prods);
        renderTabla();
        bootstrap.Modal.getInstance(document.getElementById("productoModal")).hide();
      });

      // Editar
      $(document).on("click",".editar",function(){
        const p = getProds().find(x=>String(x.id)===String($(this).data("id")));
        $("#prodId").val(p.id);
        $("#prodCodigo").val(p.codigo || '');
        $("#prodNombre").val(p.nombre);
        $("#prodPrecio").val(p.precio);
        $("#prodStock").val(p.stock);
        $("#prodDescripcion").val(p.descripcion || '');
        $("#prodCategoria").val(p.categoria || '');
        $("#prodMarca").val(p.marca || 'Custom20');
        $("#prodImg").val("");
        currentImgData = "";
        if(p.img){ $("#prodPreview").attr("src", p.img).removeClass("d-none"); }
        else { $("#prodPreview").attr("src","").addClass("d-none"); }
        new bootstrap.Modal("#productoModal").show();
      });

      // Eliminar
      $(document).on("click",".eliminar",function(){
        let prods = getProds().filter(x=>String(x.id)!==String($(this).data("id")));
        saveProds(prods);
        renderTabla();
      });

      // Botón de logout
      document.getElementById('btnLogout')?.addEventListener('click', function(e) {
        e.preventDefault();
        console.log('Cerrando sesión desde admin...');
        
        // Usar función global de logout
        if (window.globalLogout) {
          window.globalLogout();
        } else {
          // Fallback si la función global no está disponible
          localStorage.removeItem('APP_CURRENT_USER');
          window.location.href = 'index.html';
        }
      });
    });
  </script>
</body>
</html>
